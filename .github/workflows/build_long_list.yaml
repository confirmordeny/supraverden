name: Generate Combined Table

on:
workflow_dispatch:
push:
branches:
- main

jobs:
build:
runs-on: ubuntu-latest
steps:
- name: Checkout repository
uses: actions/checkout@v4

  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: '3.x'
      
  - name: Run script to combine tables
    run: |
      import os

      def combine_markdown_tables(input_files, output_file):
          print("Starting to combine tables...")
          all_rows = []
          
          final_header_row = "| English Name | Wikidata Code | Family | Source URL |\n"
          final_separator_row = "|---|---|---|---|\n"

          warning_text = (
              "<!-- WARNING: This file is generated automatically. "
              "Do not edit it directly. "
              "See the source files for modifications. -->\n\n"
          )

          for filename in input_files:
              if not os.path.exists(filename):
                  print(f"ERROR: The file '{filename}' was not found. Please ensure it exists.")
                  return
              
              try:
                  with open(filename, 'r', encoding='utf-8') as f:
                      lines = f.readlines()
                      table_start = -1
                      for i, line in enumerate(lines):
                          if line.strip().startswith('|'):
                              table_start = i
                              break
                      
                      if table_start != -1:
                          print(f"Found table in '{filename}'.")
                          for line in lines[table_start + 2:]:
                              if line.strip().startswith('|'):
                                  all_rows.append(line)
                      else:
                          print(f"WARNING: No markdown table found in '{filename}'. Skipping.")
              except IOError as e:
                  print(f"ERROR: An I/O error occurred while reading '{filename}': {e}")
                  return

          parsed_rows = []
          for row_str in all_rows:
              cells = [cell.strip() for cell in row_str.strip().strip('|').split('|')]
              if len(cells) == 4:
                  parsed_rows.append(cells)

          parsed_rows.sort(key=lambda x: x[0])

          sorted_markdown_rows = []
          for row_cells in parsed_rows:
              sorted_markdown_rows.append(f"| {' | '.join(row_cells)} |\n")
              
          try:
              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write(warning_text)
                  f.write(final_header_row)
                  f.write(final_separator_row)
                  for row in sorted_markdown_rows:
                      f.write(row)
              print(f"SUCCESS: Combined and sorted tables into '{output_file}'.")
          except IOError as e:
              print(f"ERROR: An I/O error occurred while writing to '{output_file}': {e}")
              return

      source_files = [
          'NORTH_SOUTH_IMPLEMENTATION_BODIES.md',
          'UN_BODIES.md',
      ]

      output_file_name = 'combined_table.md'

      combine_markdown_tables(source_files, output_file_name)
