name: Generate FATF Assessment Table

on:
  push:
    paths:
      - 'data/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Run Markdown Generator
        shell: python
        run: |
          import yaml
          import os
          import sys

          # Configuration
          file_1_basis = 'data/FATF_definition_analysis.yaml'
          file_2_entities = 'data/general_list.yaml'
          dist_folder = 'dist'
          output_file = os.path.join(dist_folder, 'FATF_ASSESSMENTS.md')

          # Ensure the dist directory exists
          if not os.path.exists(dist_folder):
              os.makedirs(dist_folder)

          # Verify input files exist
          for path in [file_1_basis, file_2_entities]:
              if not os.path.exists(path):
                  print(f"Error: {path} not found.")
                  sys.exit(1)

          try:
              with open(file_1_basis, 'r', encoding='utf-8') as f:
                  basis_lookup = yaml.safe_load(f) or {}
              with open(file_2_entities, 'r', encoding='utf-8') as f:
                  entities_data = yaml.safe_load(f) or {}

              markdown_lines = [
                  "# FATF Assessment Table",
                  "> This file is auto-generated. Do not edit manually.",
                  "",
                  "| Organisation | Assessment | Basis for Assessment |",
                  "| :--- | :--- | :--- |"
              ]

              for entity_name, fields in entities_data.items():
                  if not isinstance(fields, dict): continue
                  
                  assessment = fields.get('Assessment_against_FATF_definition', 'N/A')
                  basis_id = fields.get('Basis_for_assessment')
                  
                  basis_text = "No basis text found."
                  if basis_id and isinstance(basis_lookup, dict) and basis_id in basis_lookup:
                      data_entry = basis_lookup[basis_id]
                      basis_text = data_entry.get('Basis_text', str(data_entry)) if isinstance(data_entry, dict) else str(data_entry)
                  
                  clean_basis = str(basis_text).replace('\n', ' ').replace('\r', '').strip()
                  markdown_lines.append(f"| {entity_name} | {assessment} | {clean_basis} |")

              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write("\n".join(markdown_lines))
              
              print(f"Successfully generated {output_file}")

          except Exception as e:
              print(f"Workflow failed: {e}")
              sys.exit(1)

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add the entire dist folder
          git add dist/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update FATF assessments in /dist [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
          fi
