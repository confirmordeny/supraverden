name: Generate data dictionary

on:
  push:
    paths:
      - 'data/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Generate Markdown from YAML
        shell: python
        run: |
          import yaml
          import os

          # Configuration
          src_file = 'data/data_dictionary.yaml' 
          output_dir = 'dist'
          output_file = os.path.join(output_dir, 'data_dictionary.md')

          # Check if source exists
          if not os.path.exists(src_file):
              print(f"Skipping: {src_file} not found.")
              exit(0)

          # Load YAML data
          with open(src_file, 'r', encoding='utf-8') as f:
              try:
                  data = yaml.safe_load(f)
              except yaml.YAMLError as e:
                  print(f"Error parsing YAML: {e}")
                  exit(1)

          # Define the columns for the Markdown table
          headers = [
              "Property", "Title", "Data type", "Length", 
              "Requirement", "Description", "Permissible values", 
              "Validation rules", "Example"
          ]

          # Build the Markdown content
          md_content = ["# Data Dictionary", ""]
          md_content.append("| " + " | ".join(headers) + " |")
          md_content.append("| " + " | ".join(["---"] * len(headers)) + " |")

          for key, fields in data.items():
              if not isinstance(fields, dict):
                  continue
              
              row = []
              for h in headers:
                  # Get value, clean up newlines for table safety
                  val = str(fields.get(h, "")).replace("\n", " ").strip()
                  row.append(val)
              
              md_content.append("| " + " | ".join(row) + " |")

          # Create dist folder and save file
          os.makedirs(output_dir, exist_ok=True)
          with open(output_file, 'w', encoding='utf-8') as f:
              f.write("\n".join(md_content))

          print(f"Successfully generated {output_file}")

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions[bot]"
          git add dist/data_dictionary.md
          # Only commit if there are actual changes to avoid empty commit errors
          git diff-index --quiet HEAD || (git commit -m "docs: auto-generate data dictionary" && git push)
