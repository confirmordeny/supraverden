name: Generate data dictionary

on:
  push:
    paths:
      - 'data/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Generate Markdown from YAML
        shell: python
        run: |
          import yaml
          import os

          src_file = 'data/data_dictionary.yaml' 
          output_dir = 'dist'
          output_file = os.path.join(output_dir, 'DATA_DICTIONARY.md')

          if not os.path.exists(src_file):
              print(f"Skipping: {src_file} not found.")
              exit(0)

          with open(src_file, 'r', encoding='utf-8') as f:
              try:
                  data = yaml.safe_load(f)
              except yaml.YAMLError as e:
                  print(f"Error parsing YAML: {e}")
                  exit(1)

          # Mapping Display Headers to YAML Keys
          mapping = {
              "Property": "property",
              "Title": "title",
              "Data type": "type",
              "Length": "length",
              "Requirement": "requirement",
              "Description": "description",
              "Permissible values": "values",
              "Validation rules": "rules",
              "Example": "example"
          }

          headers = list(mapping.keys())
          md_content = ["# Data Dictionary", "", "| " + " | ".join(headers) + " |", "| " + " | ".join(["---"] * len(headers)) + " |"]

          # Handle both List and Dictionary YAML structures
          items = data.items() if isinstance(data, dict) else enumerate(data)

          for key, fields in items:
              if not isinstance(fields, dict): continue
              
              row = []
              for h in headers:
                  yaml_key = mapping[h]
                  # If header is 'Property' and it's missing in fields, use the YAML key
                  val = fields.get(yaml_key, key if h == "Property" else "")
                  row.append(str(val).replace("\n", " ").strip())
              
              md_content.append("| " + " | ".join(row) + " |")

          os.makedirs(output_dir, exist_ok=True)
          with open(output_file, 'w', encoding='utf-8') as f:
              f.write("\n".join(md_content))

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions[bot]"
          git add dist/DATA_DICTIONARY.md
          git diff-index --quiet HEAD || (git commit -m "docs: auto-generate data dictionary" && git push)
