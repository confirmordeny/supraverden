name: Generate data dictionary

on:
  push:
    paths:
      - 'data/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Generate Markdown from YAML
        shell: python
        run: |
          import yaml
          import os

          src_file = 'data/data_dictionary.yaml' 
          output_dir = 'dist'
          output_file = os.path.join(output_dir, 'DATA_DICTIONARY.md')

          if not os.path.exists(src_file):
              print(f"Skipping: {src_file} not found.")
              exit(0)

          with open(src_file, 'r', encoding='utf-8') as f:
              data = yaml.safe_load(f)

          headers = [
              "Property", "Title", "Data type", "Length", 
              "Requirement", "Description", "Permissible values", 
              "Validation rules", "Example"
          ]

          md_content = ["# Data Dictionary", ""]
          md_content.append("| " + " | ".join(headers) + " |")
          md_content.append("| " + " | ".join(["---"] * len(headers)) + " |")

          # Handle data as a dict (keyed by Property)
          for key, fields in data.items():
              if not isinstance(fields, dict):
                  continue
              
              row = []
              for h in headers:
                  # Robust matching: Exact, Lowercase, or Key-fallback for 'Property'
                  val = fields.get(h) or fields.get(h.lower()) or ""
                  
                  if h == "Property" and not val:
                      val = key

                  clean_val = str(val).replace("\n", " ").replace("|", "\\|").strip()
                  row.append(clean_val)
              
              md_content.append("| " + " | ".join(row) + " |")

          os.makedirs(output_dir, exist_ok=True)
          with open(output_file, 'w', encoding='utf-8') as f:
              f.write("\n".join(md_content))

      - name: Install Pandoc and TeX Live
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra

      - name: Convert Markdown to PDF
        run: |
          pandoc dist/data_dictionary.md -o dist/DATA_DICTIONATY.pdf --variable geometry:margin=1in

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions[bot]"
          git add dist/DATA_DICTIONARY.md dist/DATA_DICTIONARY.pdf
          git diff-index --quiet HEAD || (git commit -m "docs: auto-generate data dictionary (md & pdf)" && git push)
