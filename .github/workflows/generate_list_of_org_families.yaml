name: Org families list

on:
  push:
    branches:
      - main
    paths:
      - 'data/**.yaml' # Watch all yaml files in data
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # REQUIRED for committing back to the repo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # Step 1: Write the Python script to a temporary file
      # This is safer than running it inline and avoids EOF warnings.
      - name: Create Generator Script
        run: |
          cat << 'PY_SCRIPT' > generate_families.py
          import os
          from collections import Counter

          # CONFIGURATION
          input_files = [
              'data/general_list.yaml',
              'data/united_nations.yaml'
          ]
          output_file = 'dist/ORG_FAMILIES.md'

          def parse_file(filepath):
              if not os.path.exists(filepath):
                  print(f'Warning: File not found: {filepath}')
                  return []
              
              organizations = []
              # Using utf-8 to handle all special characters
              with open(filepath, 'r', encoding='utf-8') as f:
                  current_org = None
                  for line in f:
                      stripped_line = line.strip()
                      # Ignore comments
                      if not stripped_line or stripped_line.startswith('#'):
                          continue
                      
                      # New Organization detection (no indentation)
                      if not line.startswith(' '):
                          if current_org:
                              organizations.append(current_org)
                          org_name = stripped_line.rstrip(':')
                          current_org = {'_main_name': org_name}
                      
                      # Property detection (indented)
                      elif current_org is not None and ':' in stripped_line:
                          try:
                              key, value = stripped_line.split(':', 1)
                              current_org[key.strip()] = value.strip()
                          except ValueError:
                              pass # Skip malformed lines gracefully
              
              if current_org:
                  organizations.append(current_org)
              return organizations

          def generate_markdown(organizations):
              families = []
              for org in organizations:
                  fam = org.get('Org_family')
                  # robust check for null/None/'null' string
                  if fam and fam.strip() and str(fam).lower() != 'null':
                      families.append(fam.strip())
                  else:
                      families.append('Unspecified')

              counts = Counter(families)
              sorted_families = sorted(counts.keys(), key=str.casefold)

              lines = []
              for family in sorted_families:
                  count = counts[family]
                  suffix = "entity" if count == 1 else "entities"
                  lines.append(f"* {family} ({count} {suffix})")
              
              return '\n'.join(lines)

          # --- Main Execution ---
          print("Starting processing...")
          all_orgs = []
          for f in input_files:
              data = parse_file(f)
              all_orgs.extend(data)
              print(f"Loaded {len(data)} items from {f}")

          content = generate_markdown(all_orgs)
          
          # Ensure directory exists
          os.makedirs(os.path.dirname(output_file), exist_ok=True)
          
          with open(output_file, 'w', encoding='utf-8') as f:
              f.write('# Organization Families Summary\n\n')
              f.write(content)
              
          print(f"SUCCESS: Generated {output_file}")
          PY_SCRIPT

      # Step 2: Run the script
      - name: Run Generator
        run: python3 generate_families.py

      # Step 3: Debugging - Verify the file exists
      - name: Verify Output
        run: |
          echo "Checking contents of dist folder:"
          ls -la dist/ || echo "Dist folder not found!"

      # Step 4: Commit and Push
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Update organization families summary"
          file_pattern: "dist/ORG_FAMILIES.md"
          skip_fetch: true
