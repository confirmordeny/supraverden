name: Enrich data with data from Wikidata

on:
  workflow_dispatch: 

permissions:
  contents: write 

jobs:
  enrich-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml requests

      - name: Run Enrichment Script
        shell: python
        run: |
          import yaml
          import requests
          import sys
          import re
          import os
          import time

          TARGET_FILES = ['data/general_list.yaml', 'data/united_nations.yaml']
          WIKIDATA_ENDPOINT = "https://query.wikidata.org/sparql"
          USER_AGENT = "SupraverdenBot/1.0 (github.com/confirmordeny/supraverden)"

          def get_wikidata_data(q_code):
              time.sleep(1.0)
              query = f"""
              SELECT ?id ?name_fr ?name_es WHERE {{
                BIND(wd:{q_code} AS ?item)
                OPTIONAL {{ ?item wdt:P10632 ?id . }}
                OPTIONAL {{ ?item rdfs:label ?name_fr . FILTER(LANG(?name_fr) = "fr") }}
                OPTIONAL {{ ?item rdfs:label ?name_es . FILTER(LANG(?name_es) = "es") }}
              }}
              LIMIT 1
              """
              try:
                  response = requests.get(
                      WIKIDATA_ENDPOINT, 
                      params={'format': 'json', 'query': query}, 
                      headers={'User-Agent': USER_AGENT},
                      timeout=30
                  )
                  if response.status_code == 200:
                      data = response.json()
                      bindings = data.get('results', {}).get('bindings', [])
                      if bindings:
                          result_row = bindings[0]
                          return {
                              'os_id': result_row.get('id', {}).get('value'),
                              'name_fr': result_row.get('name_fr', {}).get('value'),
                              'name_es': result_row.get('name_es', {}).get('value')
                          }
                  return {}
              except:
                  return {}

          def process_single_file(file_path):
              print(f"Checking {file_path}...")
              if not os.path.exists(file_path):
                  return False
              with open(file_path, 'r', encoding='utf-8') as f:
                  original_content = f.read()
              
              header_match = re.match(r'^(\s*#.*|\s*\n)*', original_content)
              header_block = header_match.group(0) if header_match else ""
              
              try:
                  data = yaml.safe_load(original_content)
              except:
                  return False
              if not data:
                  return False

              updates_count = 0
              for org_name, info in data.items():
                  if not isinstance(info, dict) or 'Wikidata_code' not in info:
                      continue
                  
                  w_code = str(info['Wikidata_code']).replace('[', '').replace(']', '').strip()
                  if not w_code.startswith('Q'):
                      continue
                  
                  needs_os = 'OpenSanctions_id' not in info
                  needs_fr = 'Name_fr' not in info
                  needs_es = 'Name_es' not in info
                  
                  if needs_os or needs_fr or needs_es:
                      remote = get_wikidata_data(w_code)
                      if not remote:
                          continue
                      
                      changed = False
                      if needs_os and remote.get('os_id'):
                          info['OpenSanctions_id'] = remote['os_id']
                          changed = True
                      if needs_fr and remote.get('name_fr'):
                          info['Name_fr'] = remote['name_fr']
                          changed = True
                      if needs_es and remote.get('name_es'):
                          info['Name_es'] = remote['name_es']
                          changed = True
                      
                      if changed:
                          updates_count += 1

              if updates_count > 0:
                  print(f"Saving {updates_count} updates...")
                  with open(file_path, 'w', encoding='utf-8') as f:
                      f.write(header_block)
                      yaml.dump(data, f, default_flow_style=False, sort_keys=False, allow_unicode=True, width=1000)
                  return True
              return False

          any_updated = False
          for path in TARGET_FILES:
              if process_single_file(path):
                  any_updated = True
          
          if not any_updated:
              print("No changes found.")

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot
