name: Generate list of keys

on:
  push:
    branches:
      - main
    paths:
      - 'data/arab_league_bodies.yaml'
      - 'data/eu_bodies.yaml'
      - 'data/general_list.yaml'
      - 'data/north_south_bodies.yaml'
      - 'data/oas_bodies.yaml'
      - 'data/united_nations.yaml'
      
  workflow_dispatch:

jobs:
  extract-keys:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Extract Keys and Generate List
        run: |
          python3 - <<'EOF'
          import os
          from collections import defaultdict

          # Input files configuration
          input_files = [
              'data/arab_league_bodies.yaml',
              'data/eu_bodies.yaml',
              'data/general_list.yaml',
              'data/oas_bodies.yaml',
              'data/north_south_bodies.yaml',
              'data/united_nations.yaml'
          ]
          output_file = 'dist/LIST_OF_KEYS.md'

          unique_keys = set()

          print("Scanning files for keys...")

          for filepath in input_files:
              if not os.path.exists(filepath):
                  print(f"Skipping missing file: {filepath}")
                  continue

              with open(filepath, 'r', encoding='utf-8') as f:
                  for line in f:
                      stripped = line.strip()
                      
                      # Parsing logic:
                      if line.startswith(' ') and ':' in stripped and not stripped.startswith('#'):
                          key = stripped.split(':', 1)[0].strip()
                          unique_keys.add(key)

          # --- NEW GROUPING LOGIC ---
          
          # Dictionary to hold { "Head": ["variant1", "variant2"] }
          grouped_keys = defaultdict(list)

          for key in unique_keys:
              if '_' in key:
                  # Split on the FIRST underscore only.
                  # e.g. "Name_former_en" -> Head: "Name", Variant: "former_en"
                  head, variant = key.split('_', 1)
                  grouped_keys[head].append(variant)
              else:
                  # If no underscore (e.g. "Country"), ensure it exists as a key with no variants
                  if key not in grouped_keys:
                      grouped_keys[key] = []

          # Build the output string
          output_lines = []
          
          # Sort the Main Headings alphabetically
          for head in sorted(grouped_keys.keys()):
              output_lines.append(f"* {head}")
              
              # Sort the variants alphabetically and indent them
              for variant in sorted(grouped_keys[head]):
                  output_lines.append(f"  * {variant}")

          formatted_output = "\n".join(output_lines)
          
          # --------------------------

          # Ensure output directory exists
          os.makedirs(os.path.dirname(output_file), exist_ok=True)

          # Write to file
          with open(output_file, 'w', encoding='utf-8') as f:
              f.write(formatted_output)

          print(f"Successfully wrote grouped keys to {output_file}")
          EOF

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Update LIST_OF_KEYS.md with grouping"
          file_pattern: "dist/LIST_OF_KEYS.md"
